
<div class="header">
<span class="logo">DeepPhe-Viz | </span> <span class="current_patient">{{patientName}}</span> (<a href="{{baseUri}}/cohortAnalysis" class="choose_patient_link">Cohort Analysis</a>)
</div>

<div class="main">

<div class="left">

<div id="info"></div>

<div id="cancer"></div>

<div id="tumors"></div>

</div>


<div class="right">

<div class="section_heading">Report</div>

<div class="report_section clearfix">
<div id="timeline" class="clearfix"></div>

<div class="divider clearfix"></div>

<div id="fact_detail"></div>

<div class="report_area_left">
<div id="report_id"></div>
<div id="report_mentioned_terms" ></div>
</div>

<div id="report_text"></div>

</div>

</div>

</div>


<script type="text/javascript">
const patientName = '{{patientName}}';
const baseUri = '{{baseUri}}';

// Get pateint info
getPatientInfo(patientName);

// Get patient cancer symmary and reports
getCancerSummary(patientName);

// Hard coded cancer ID for now, 'CancerSummary-Melanoma' or 'CancerSummary-Breast'
getTumorSummary(patientName);

// Render timeline to the target container id
getTimeline(patientName, "timeline");

// Shorthand for $( document ).ready(), recommended
// We need to attach the click event to the document or the partial view's parent element
// otherwise we'll have to put the client event listener in the individual view template to get it work
$(function() {
    // Cancer fact click
    $(document).on("click", "#cancer .fact", function() {
        const cssClass = 'highlighted_fact';
        
        // Remove the previous highlighting
        $('.fact').removeClass(cssClass);

        let factId = $(this).attr('id');
        getFact(patientName, factId);

        // Highlight the clicked fact
        $(this).addClass(cssClass);
    });

    // Tumor fact click - List View
    $(document).on("click", "#list_view .fact", function() {
        const cssClass = 'highlighted_fact';

        // Remove the previous highlighting
        $('.fact').removeClass(cssClass);

        // "list_view_{{id}}"
        let id = $(this).attr('id');
        let factId = id.substring(10);
        getFact(patientName, factId);

        // Highlight the clicked fact
        $(this).addClass(cssClass);

        // Also highlight the same fact in table view
        $("#table_view_"+factId).addClass(cssClass);
    });

    // Tumor fact click - Table View
    $(document).on("click", "#table_view .fact", function() {
        const cssClass = 'highlighted_fact';

        // Remove the previous highlighting
        $('.fact').removeClass(cssClass);

        // "table_view_{{id}}"
        let id = $(this).attr('id');
        let factId = id.substring(11);
        getFact(patientName, factId);

        // Highlight the clicked fact
        $(this).addClass(cssClass);

        // Also highlight the same fact in list view
        $("#list_view_"+factId).addClass(cssClass);
    });

    // Tumor summary
    $(document).on("click", "#list_view_option", function() {
        $("#table_view").hide();
        $("#list_view").show();
    });

    $(document).on("click", "#table_view_option", function() {
        $("#list_view").hide();
        $("#table_view").show();
    });

    // Toggle for each tumor type under list view
    $(document).on("click", ".list_view_tumor_type", function() {
        $(this).next().find(".toggleable").toggle("fast");
        $(this).find(".fa-caret-right, .fa-caret-down").toggle();
    });

    // Click the fact based report id to display report content
    $(document).on("click", ".fact_based_report_id", function() {
        const cssClass = 'current_displaying_report';
        // First remove the previously added highlighting
        $('.fact_based_report_id').removeClass(cssClass);
        // Then add to this one
        $(this).addClass(cssClass);

        let reportId = $(this).attr('id');
        getReport(reportId);

        // Also highlight the selected report circle in timeline
        highlightSelectedTimelineReport(reportId)
    });

    // Click the report mentioned term to show it in the report text
    $(document).on("click", ".report_mentioned_term", function() {
        // Highlight the selected term in the term list
        const cssClass = 'current_mentioned_term';
        // First remove the previously added highlighting
        $('.report_mentioned_term').removeClass(cssClass);
        // Then add to this one
        $(this).addClass(cssClass);

        let reportTextDiv = $("#report_text");

        // Use text() instead of html() to only get the combined text without any html tags
        let reportText = reportTextDiv.text();

        let textMentions = [];

        let termObj = {};
        termObj.text = $(this).text();
        termObj.startOffset = $(this).data('start');
        termObj.endOffset = $(this).data('end');
        
        textMentions.push(termObj);

        // Highlight this term in the report text
        let highlightedReportText = highlightMentionedTexts(textMentions, reportText);

        // Use html() for html rendering
        $("#report_text").html(highlightedReportText);

        // Scroll to that position inside the report text div
        // https://stackoverflow.com/questions/2346011/how-do-i-scroll-to-an-element-within-an-overflowed-div
        // 5 is position tweak
        reportTextDiv.scrollTop(reportTextDiv.scrollTop() + $('.highlighted_term').position().top - 5);
    });

    // Reset button event
    $(document).on("click", "#reset", function() {
        // Remove highlighted fact
        $('.fact').removeClass('highlighted_fact');

        // Reload timeline
        $('#timeline').html('');
        getTimeline(patientName, "timeline");

        // Reset the fact detail and displaying document content
        $('#fact_detail').html('');
        $('#report_id').html('');
        $('#report_mentioned_terms').html('');
        $('#report_text').html('');
    });

});
    
</script>
